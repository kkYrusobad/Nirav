#!/bin/bash

# niri-record - Toggle screen recording with gpu-screen-recorder
# Requires: gpu-screen-recorder (install with: sudo pacman -S gpu-screen-recorder)

PID_FILE="/tmp/niri-record.pid"
VIDEO_DIR="$HOME/Videos"
DATE=$(date +%Y-%m-%d_%H-%M-%S)
FILENAME="$VIDEO_DIR/recording_$DATE.mp4"

# Check for gpu-screen-recorder
if ! command -v gpu-screen-recorder &>/dev/null; then
    notify-send -u critical "Screen Recorder" "gpu-screen-recorder not found!\nInstall with: sudo pacman -S gpu-screen-recorder" -i "dialog-error"
    exit 1
fi

# Ensure video directory exists
mkdir -p "$VIDEO_DIR"

LOG_FILE="/tmp/niri-record-debug.log"
echo "$(date): Script started" >> "$LOG_FILE"

# Check if already recording
if [ -f "$PID_FILE" ]; then
    PID=$(cat "$PID_FILE")
    if kill -0 "$PID" 2>/dev/null; then
        # Stop recording
        kill -SIGINT "$PID"
        rm "$PID_FILE"
        notify-send -a "Screen Recorder" "Recording Stopped" "Saved to $FILENAME" -i "media-record"
        echo "$(date): Stopped recording PID $PID" >> "$LOG_FILE"
        exit 0
    else
        # Stale PID file
        rm "$PID_FILE"
        echo "$(date): Removed stale PID file" >> "$LOG_FILE"
    fi
fi

# Start recording (Direct Portal Mode)
notify-send -a "Screen Recorder" "Recording Started" "Select window/region..." -i "media-record"
echo "$(date): Starting recording in portal mode" >> "$LOG_FILE"

# Use portal for window selection
nohup gpu-screen-recorder -w portal -f 60 -a default_output -o "$FILENAME" >/dev/null 2>&1 &
PID=$!
echo $PID > "$PID_FILE"
echo "$(date): Started Portal recording with PID $PID" >> "$LOG_FILE"
disown
