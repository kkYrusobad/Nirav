import QtQuick
import QtQuick.Layouts
import Quickshell
import Quickshell.Io
import Quickshell.Services.UPower
import qs.Commons
import qs.Services.Hardware
import qs.Services.Networking
import qs.Services.Power

/*
 * BatteryPanel - Popup panel with detailed battery information
 * Shows: Battery percentage, time remaining, health, power rate, Bluetooth devices
 */
PopupWindow {
  id: root

  property Item anchorItem: null
  property ShellScreen screen: null

  visible: false
  color: "transparent"

  // Position below the anchor item
  anchor.item: anchorItem
  anchor.rect.x: anchorItem ? (anchorItem.width - panelWidth) / 2 : 0
  anchor.rect.y: anchorItem ? anchorItem.height + Style.marginS : 0

  property real panelWidth: 280

  implicitWidth: panelContent.width
  implicitHeight: panelContent.height

  function toggle() {
    if (visible) {
      close();
    } else {
      open();
    }
  }

  function open() {
    PanelState.openPanel(root);
    visible = true;
  }

  function close() {
    visible = false;
    PanelState.panelClosed(root);
  }

  // Battery data
  readonly property var battery: UPower.displayDevice
  readonly property bool isReady: battery && battery.ready && battery.percentage !== undefined
  readonly property real percent: isReady ? Math.round(battery.percentage * 100) : 0
  readonly property bool charging: isReady ? battery.state === UPowerDeviceState.Charging : false

  // Panel background
  Rectangle {
    id: panelContent
    width: root.panelWidth
    height: contentColumn.implicitHeight + Style.marginL * 2
    radius: Style.radiusL
    color: Color.mSurface
    border.color: Color.mOutline
    border.width: Style.borderS

    // Shadow effect
    Rectangle {
      anchors.fill: parent
      anchors.margins: -2
      z: -1
      radius: parent.radius + 2
      color: Qt.alpha(Color.mShadow, 0.3)
    }

    ColumnLayout {
      id: contentColumn
      anchors.fill: parent
      anchors.margins: Style.marginL
      spacing: Style.marginM

      // Header with battery icon and percentage
      Rectangle {
        Layout.fillWidth: true
        Layout.preferredHeight: 60
        radius: Style.radiusM
        color: Color.mPrimary

        RowLayout {
          anchors.fill: parent
          anchors.margins: Style.marginM
          spacing: Style.marginM

          Text {
            text: BatteryService.getIcon(root.percent, root.charging, root.isReady)
            color: Color.mOnPrimary
            font.family: Style.fontFamily
            font.pixelSize: 32
          }

          Column {
            Layout.fillWidth: true
            spacing: -2

            Text {
              text: root.isReady ? root.percent + "%" : "—"
              color: Color.mOnPrimary
              font.family: Style.fontFamily
              font.pixelSize: Style.fontSizeXXL
              font.weight: Style.fontWeightBold
            }

            Text {
              text: root.charging ? "Charging" : "Discharging"
              color: Qt.alpha(Color.mOnPrimary, 0.8)
              font.family: Style.fontFamily
              font.pixelSize: Style.fontSizeS
            }
          }
        }
      }

      // Battery details card
      Rectangle {
        Layout.fillWidth: true
        Layout.preferredHeight: detailsColumn.implicitHeight + Style.marginM * 2
        radius: Style.radiusM
        color: Color.mSurfaceVariant
        border.color: Color.mOutline
        border.width: Style.borderS
        visible: root.isReady

        ColumnLayout {
          id: detailsColumn
          anchors.fill: parent
          anchors.margins: Style.marginM
          spacing: Style.marginS

          // Time remaining/to full
          RowLayout {
            Layout.fillWidth: true

            Text {
              text: "󰥔"
              color: Color.mPrimary
              font.family: Style.fontFamily
              font.pixelSize: Style.fontSizeL
            }

            Text {
              text: root.charging ? "Time to full" : "Time remaining"
              color: Color.mOnSurfaceVariant
              font.family: Style.fontFamily
              font.pixelSize: Style.fontSizeS
              Layout.fillWidth: true
            }

            Text {
              text: {
                if (root.charging && root.battery.timeToFull > 0) {
                  return Time.formatVagueHumanReadableDuration(root.battery.timeToFull);
                }
                if (!root.charging && root.battery.timeToEmpty > 0) {
                  return Time.formatVagueHumanReadableDuration(root.battery.timeToEmpty);
                }
                return "N/A";
              }
              color: Color.mOnSurface
              font.family: Style.fontFamily
              font.pixelSize: Style.fontSizeS
              font.weight: Style.fontWeightSemiBold
            }
          }

          // Power rate
          RowLayout {
            Layout.fillWidth: true

            Text {
              text: "󱐋"
              color: Color.mPrimary
              font.family: Style.fontFamily
              font.pixelSize: Style.fontSizeL
            }

            Text {
              text: "Power"
              color: Color.mOnSurfaceVariant
              font.family: Style.fontFamily
              font.pixelSize: Style.fontSizeS
              Layout.fillWidth: true
            }

            Text {
              text: root.battery.changeRate && root.battery.changeRate !== 0 ? Math.abs(root.battery.changeRate).toFixed(1) + " W" : "N/A"
              color: Color.mOnSurface
              font.family: Style.fontFamily
              font.pixelSize: Style.fontSizeS
              font.weight: Style.fontWeightSemiBold
            }
          }

          // Health
          RowLayout {
            Layout.fillWidth: true

            Text {
              text: "󰛨"
              color: Color.mPrimary
              font.family: Style.fontFamily
              font.pixelSize: Style.fontSizeL
            }

            Text {
              text: "Health"
              color: Color.mOnSurfaceVariant
              font.family: Style.fontFamily
              font.pixelSize: Style.fontSizeS
              Layout.fillWidth: true
            }

            Text {
              text: root.battery.healthPercentage && root.battery.healthPercentage > 0 ? Math.round(root.battery.healthPercentage) + "%" : "N/A"
              color: Color.mOnSurface
              font.family: Style.fontFamily
              font.pixelSize: Style.fontSizeS
              font.weight: Style.fontWeightSemiBold
            }
          }
        }
      }

      // Bluetooth devices card
      Rectangle {
        Layout.fillWidth: true
        Layout.preferredHeight: btColumn.implicitHeight + Style.marginM * 2
        radius: Style.radiusM
        color: Color.mSurfaceVariant
        border.color: Color.mOutline
        border.width: Style.borderS
        visible: BluetoothService.allDevicesWithBattery && BluetoothService.allDevicesWithBattery.length > 0

        ColumnLayout {
          id: btColumn
          anchors.fill: parent
          anchors.margins: Style.marginM
          spacing: Style.marginS

          // Header
          RowLayout {
            Layout.fillWidth: true

            Text {
              text: "󰂯"
              color: Color.mPrimary
              font.family: Style.fontFamily
              font.pixelSize: Style.fontSizeL
            }

            Text {
              text: "Bluetooth Devices"
              color: Color.mOnSurface
              font.family: Style.fontFamily
              font.pixelSize: Style.fontSizeS
              font.weight: Style.fontWeightSemiBold
              Layout.fillWidth: true
            }
          }

          // Device list
          Repeater {
            model: BluetoothService.allDevicesWithBattery || []

            RowLayout {
              Layout.fillWidth: true

              Text {
                text: BluetoothService.getBattery(modelData)
                color: Color.mOnSurfaceVariant
                font.family: Style.fontFamily
                font.pixelSize: Style.fontSizeS
                Layout.fillWidth: true
              }
            }
          }
        }
      }

      // Power Profile section
      Rectangle {
        Layout.fillWidth: true
        Layout.preferredHeight: profileColumn.implicitHeight + Style.marginM * 2
        radius: Style.radiusM
        color: Color.mSurfaceVariant
        border.color: Color.mOutline
        border.width: Style.borderS
        visible: PowerProfileService.available

        ColumnLayout {
          id: profileColumn
          anchors.fill: parent
          anchors.margins: Style.marginM
          spacing: Style.marginS

          // Section header
          RowLayout {
            Layout.fillWidth: true
            spacing: Style.marginS

            Text {
              text: PowerProfileService.getIcon()
              color: Color.mPrimary
              font.family: Style.fontFamily
              font.pixelSize: Style.fontSizeL
            }

            Text {
              text: "Power Profile"
              color: Color.mOnSurface
              font.family: Style.fontFamily
              font.pixelSize: Style.fontSizeS
              font.weight: Style.fontWeightMedium
              Layout.fillWidth: true
            }
          }

          // Profile buttons
          RowLayout {
            Layout.fillWidth: true
            spacing: Style.marginS

            // Power Saver button
            Rectangle {
              Layout.fillWidth: true
              Layout.preferredHeight: 36
              radius: Style.radiusS
              color: PowerProfileService.profile === 2 ? Color.mPrimary : (saverMouseArea.containsMouse ? Qt.alpha(Color.mPrimary, 0.2) : "transparent")
              border.color: PowerProfileService.profile === 2 ? Color.mPrimary : Color.mOutline
              border.width: 1

              ColumnLayout {
                anchors.centerIn: parent
                spacing: -2

                Text {
                  text: "󰌪"
                  color: PowerProfileService.profile === 2 ? Color.mOnPrimary : Color.mOnSurface
                  font.family: Style.fontFamily
                  font.pixelSize: Style.fontSizeL
                  Layout.alignment: Qt.AlignHCenter
                }

                Text {
                  text: "Saver"
                  color: PowerProfileService.profile === 2 ? Color.mOnPrimary : Color.mOnSurfaceVariant
                  font.family: Style.fontFamily
                  font.pixelSize: 8
                  Layout.alignment: Qt.AlignHCenter
                }
              }

              MouseArea {
                id: saverMouseArea
                anchors.fill: parent
                hoverEnabled: true
                cursorShape: Qt.PointingHandCursor
                onClicked: PowerProfileService.setProfile(2)  // PowerSaver
              }
            }

            // Balanced button
            Rectangle {
              Layout.fillWidth: true
              Layout.preferredHeight: 36
              radius: Style.radiusS
              color: PowerProfileService.profile === 1 ? Color.mPrimary : (balancedMouseArea.containsMouse ? Qt.alpha(Color.mPrimary, 0.2) : "transparent")
              border.color: PowerProfileService.profile === 1 ? Color.mPrimary : Color.mOutline
              border.width: 1

              ColumnLayout {
                anchors.centerIn: parent
                spacing: -2

                Text {
                  text: "󰛲"
                  color: PowerProfileService.profile === 1 ? Color.mOnPrimary : Color.mOnSurface
                  font.family: Style.fontFamily
                  font.pixelSize: Style.fontSizeL
                  Layout.alignment: Qt.AlignHCenter
                }

                Text {
                  text: "Balanced"
                  color: PowerProfileService.profile === 1 ? Color.mOnPrimary : Color.mOnSurfaceVariant
                  font.family: Style.fontFamily
                  font.pixelSize: 8
                  Layout.alignment: Qt.AlignHCenter
                }
              }

              MouseArea {
                id: balancedMouseArea
                anchors.fill: parent
                hoverEnabled: true
                cursorShape: Qt.PointingHandCursor
                onClicked: PowerProfileService.setProfile(1)  // Balanced
              }
            }

            // Performance button
            Rectangle {
              Layout.fillWidth: true
              Layout.preferredHeight: 36
              radius: Style.radiusS
              color: PowerProfileService.profile === 0 ? Color.mPrimary : (perfMouseArea.containsMouse ? Qt.alpha(Color.mPrimary, 0.2) : "transparent")
              border.color: PowerProfileService.profile === 0 ? Color.mPrimary : Color.mOutline
              border.width: 1

              ColumnLayout {
                anchors.centerIn: parent
                spacing: -2

                Text {
                  text: "󱐋"
                  color: PowerProfileService.profile === 0 ? Color.mOnPrimary : Color.mOnSurface
                  font.family: Style.fontFamily
                  font.pixelSize: Style.fontSizeL
                  Layout.alignment: Qt.AlignHCenter
                }

                Text {
                  text: "Perf"
                  color: PowerProfileService.profile === 0 ? Color.mOnPrimary : Color.mOnSurfaceVariant
                  font.family: Style.fontFamily
                  font.pixelSize: 8
                  Layout.alignment: Qt.AlignHCenter
                }
              }

              MouseArea {
                id: perfMouseArea
                anchors.fill: parent
                hoverEnabled: true
                cursorShape: Qt.PointingHandCursor
                onClicked: PowerProfileService.setProfile(0)  // Performance
              }
            }
          }
        }
      }

      // Open battop button
      Rectangle {
        Layout.fillWidth: true
        Layout.preferredHeight: 36
        radius: Style.radiusS
        color: battopMouseArea.containsMouse ? Qt.alpha(Color.mPrimary, 0.2) : Color.mSurfaceVariant
        border.color: Color.mOutline
        border.width: Style.borderS

        RowLayout {
          anchors.centerIn: parent
          spacing: Style.marginS

          Text {
            text: "󰄛"
            color: Color.mPrimary
            font.family: Style.fontFamily
            font.pixelSize: Style.fontSizeL
          }

          Text {
            text: "Open Battery Monitor"
            color: Color.mOnSurface
            font.family: Style.fontFamily
            font.pixelSize: Style.fontSizeS
            font.weight: Style.fontWeightMedium
          }
        }

        MouseArea {
          id: battopMouseArea
          anchors.fill: parent
          hoverEnabled: true
          cursorShape: Qt.PointingHandCursor
          onClicked: {
            root.close();
            battopProcess.running = true;
          }
        }
      }
    }

    // Animation
    scale: root.visible ? 1.0 : 0.95
    opacity: root.visible ? 1.0 : 0.0
    transformOrigin: Item.Top

    Behavior on scale {
      NumberAnimation {
        duration: Style.animationFast
        easing.type: Easing.OutCubic
      }
    }

    Behavior on opacity {
      NumberAnimation {
        duration: Style.animationFast
        easing.type: Easing.OutCubic
      }
    }
  }

  // Process to open battop
  Process {
    id: battopProcess
    command: ["/home/kky/garbage/noctaliaChange/oNIgiRI/bin/niri-launch-or-focus-tui", "--floating", "--center", "--name", "Battop", "battop"]
  }

  // Close on Escape key
  Shortcut {
    sequence: "Escape"
    enabled: root.visible
    onActivated: root.close()
  }
}
